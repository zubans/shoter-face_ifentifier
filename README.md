# Техническое задание

## AR-игра-шутер с цифровыми профилями игроков

**Версия документа:** 1.0  
**Дата создания:** 25.06.2025  
**Заказчик:** -  
**Исполнитель:** -  

---

## Содержание

1. [Введение](#1-введение)
   1. [Цель проекта](#11-цель-проекта)
   2. [Глоссарий](#12-глоссарий)
   3. [Общее описание](#13-общее-описание)

2. [Архитектура системы](#2-архитектура-системы)
   1. [Компоненты системы](#21-компоненты-системы)
   2. [Схема взаимодействия компонентов](#22-схема-взаимодействия-компонентов)
   3. [Технологический стек](#23-технологический-стек)

3. [Функциональные требования](#3-функциональные-требования)
   1. [Android-приложение](#31-android-приложение)
   2. [Go-сервер](#32-go-сервер)
   3. [Python-сервис распознавания лиц](#33-python-сервис-распознавания-лиц)
   4. [Хранилище данных](#34-хранилище-данных)

4. [Бизнес-процессы](#4-бизнес-процессы)
   1. [Регистрация игрока](#41-регистрация-игрока)
   2. [Выбор режима игры](#42-выбор-режима-игры)
   3. [Игровой процесс](#43-игровой-процесс)
   4. [Завершение игры](#44-завершение-игры)

5. [API](#5-api)
   1. [Общие принципы](#51-общие-принципы)
   2. [Эндпоинты и методы](#52-эндпоинты-и-методы)
   3. [Примеры запросов и ответов](#53-примеры-запросов-и-ответов)

6. [Структуры данных](#6-структуры-данных)
   1. [Профиль игрока](#61-профиль-игрока)
   2. [Игровая сессия](#62-игровая-сессия)

7. [Нефункциональные требования](#7-нефункциональные-требования)
   1. [Безопасность](#71-безопасность)
   2. [Производительность](#72-производительность)
   3. [Масштабируемость](#73-масштабируемость)

8. [Этапы реализации](#8-этапы-реализации)
   1. [План разработки](#81-план-разработки)
   2. [Критерии приемки](#82-критерии-приемки)

9. [Дополнительные материалы](#9-дополнительные-материалы)

---

## 1. Введение

### 1.1 Цель проекта

Разработка многопользовательской мобильной игры с дополненной реальностью, распознаванием игроков по внешнему виду и боевой механикой, основанной на камере устройства. Ключевой особенностью является создание временных цифровых профилей игроков на основе фотографий с разных ракурсов и их использование для идентификации целей во время игрового процесса.

### 1.2 Глоссарий

- **AR (Augmented Reality)** — дополненная реальность, технология, накладывающая цифровые элементы на изображение реального мира.
- **Face Recognition** — технология распознавания лиц, позволяющая идентифицировать людей по их внешности.
- **Face Embedding** — векторное представление лица, используемое для сравнения и идентификации.
- **PlayerId** — уникальный идентификатор игрока в системе.
- **Game Session** — игровая сессия, период от начала до окончания одной игры.
- **Go** — компилируемый язык программирования для бэкенда, разработанный Google.
- **REST API** — архитектурный стиль взаимодействия компонентов распределённого приложения.

### 1.3 Общее описание

Проект представляет собой AR-игру с временным биометрическим распознаванием для развлечения в группе. Игроки собираются в физическом пространстве, регистрируются в приложении, делают 4 фото с разных сторон для создания временного цифрового профиля, который существует только на время игры.

Во время игры устройство через камеру и нейросеть определяет, в кого целится игрок, и обрабатывает «выстрелы» с учётом точки попадания (голова, тело, ноги). Система обеспечивает различные режимы игры, такие как PvP, командный режим и режим "дойти до точки".

Все данные профилей хранятся временно и только на время игровой сессии, обеспечивая конфиденциальность пользователей.

## 2. Архитектура системы

### 2.1 Компоненты системы

Система состоит из четырех основных компонентов:

1. **Android-клиент (AR-приложение)**:
   - Пользовательский интерфейс с элементами дополненной реальности
   - Камера для съемки фото и распознавания других игроков
   - Система регистрации и аутентификации игроков
   - Модуль визуализации игрового процесса

2. **Go-сервер (игровая логика, API, сессии)**:
   - REST API для взаимодействия с клиентами
   - Игровая логика и правила
   - Обработка игровых событий
   - Управление игровыми сессиями и командами

3. **Python-сервис (распознавание по фото)**:
   - Модуль обработки и распознавания лиц
   - Сравнение изображений с хранящимися профилями
   - Генерация и сравнение face embeddings

4. **Память сессии (временное хранилище цифровых профилей)**:
   - Хранение профилей игроков
   - Хранение состояния игровых сессий
   - Временное хранение данных игровой статистики

### 2.2 Схема взаимодействия компонентов

Взаимодействие между компонентами системы осуществляется по следующей схеме:

1. **Android-клиент → Go-сервер**:
   - Отправка фотографий для регистрации
   - Отправка запросов на создание и присоединение к игре
   - Отправка информации о выстрелах
   - Получение обновлений игрового состояния

2. **Go-сервер → Python-сервис**:
   - Передача фотографий для создания профиля
   - Передача изображений для распознавания лиц
   - Получение результатов распознавания

3. **Go-сервер ↔ Память сессии**:
   - Сохранение и получение профилей игроков
   - Сохранение и получение игровых сессий
   - Обновление состояния игры

### 2.3 Технологический стек

#### Android-клиент:
- **Язык программирования**: Kotlin/Java
- **AR-фреймворк**: ARCore
- **Сетевая библиотека**: Retrofit
- **Обработка изображений**: CameraX, ML Kit

#### Go-сервер:
- **Язык программирования**: Go 1.18+
- **Веб-фреймворк**: Gin или Echo
- **Управление зависимостями**: Go Modules
- **Логирование**: Zap

#### Python-сервис:
- **Язык программирования**: Python 3.8+
- **Веб-фреймворк**: FastAPI или Flask
- **Распознавание лиц**: face_recognition или InsightFace
- **Обработка изображений**: OpenCV, NumPy

#### Инфраструктура:
- **Контейнеризация**: Docker
- **Оркестрация**: Docker Compose
- **Временное хранилище**: In-memory (RAM) или Redis
- **Коммуникация**: REST API, JSON

## 3. Функциональные требования

### 3.1 Android-приложение

#### 3.1.1 Регистрация и профиль
- Приложение должно позволять пользователю создать временный профиль, сделав 4 фотографии (спереди, слева, справа, сзади)
- Приложение должно обеспечивать интерфейс для выравнивания лица при съемке
- Приложение должно отправлять фотографии на сервер и получать назначенный playerId

#### 3.1.2 AR-интерфейс
- Приложение должно обеспечивать наложение AR-элементов на камеру устройства
- Приложение должно отображать прицел в центре экрана
- Приложение должно визуально отмечать распознанных игроков
- Приложение должно визуализировать попадания (удар, урон, смерть и т.д.)

#### 3.1.3 Игровой процесс
- Приложение должно обеспечивать выбор режима игры (PvP, командный, "дойти до точки")
- Приложение должно обрабатывать нажатие на кнопку "огонь" и отправлять данные на сервер
- Приложение должно отображать статус игрока (здоровье, статистика)
- Приложение должно визуализировать результаты игры

### 3.2 Go-сервер

#### 3.2.1 API
- Сервер должен предоставлять REST API для взаимодействия с клиентами
- Сервер должен обрабатывать запросы на создание профиля игрока
- Сервер должен обрабатывать запросы на создание и управление игровыми сессиями
- Сервер должен обрабатывать запросы, связанные с игровым процессом (выстрелы, попадания)

#### 3.2.2 Игровая логика
- Сервер должен управлять игровыми сессиями и состояниями
- Сервер должен обрабатывать логику попаданий и урона
- Сервер должен управлять командами в командном режиме
- Сервер должен определять окончание игры и победителей

#### 3.2.3 Взаимодействие с Python-сервисом
- Сервер должен передавать изображения в Python-сервис для распознавания
- Сервер должен обрабатывать ответы от Python-сервиса
- Сервер должен делегировать распознавание лиц Python-сервису

### 3.3 Python-сервис распознавания лиц

#### 3.3.1 Обработка изображений
- Сервис должен принимать изображения в формате base64
- Сервис должен обрабатывать изображения для распознавания лиц
- Сервис должен детектировать лица на изображениях

#### 3.3.2 Распознавание лиц
- Сервис должен создавать face embeddings из изображений
- Сервис должен сравнивать полученные изображения с хранящимися профилями
- Сервис должен возвращать идентифицированный playerId и степень совпадения

#### 3.3.3 API
- Сервис должен предоставлять API для распознавания лиц
- Сервис должен обрабатывать POST-запросы с изображениями
- Сервис должен возвращать результаты распознавания в формате JSON

### 3.4 Хранилище данных

#### 3.4.1 Хранение профилей
- Система должна хранить временные профили игроков
- Система должна хранить face embeddings для каждого профиля
- Система должна обеспечивать быстрый доступ к профилям

#### 3.4.2 Хранение игровых сессий
- Система должна хранить информацию о текущих игровых сессиях
- Система должна хранить состояние игры и игроков
- Система должна хранить статистику игровых сессий

#### 3.4.3 Безопасность данных
- Система должна хранить все данные только в оперативной памяти или временном хранилище
- Система должна удалять все данные после окончания игровой сессии
- Система не должна сохранять лица или UUID между играми

## 4. Бизнес-процессы

### 4.1 Регистрация игрока

1. Игрок запускает приложение
2. Игрок выбирает опцию "Новая игра"
3. Игрок делает 4 фотографии с разных ракурсов (фронт, лево, право, зад)
4. Фотографии отправляются на Go-сервер
5. Go-сервер передает фотографии в Python-сервис
6. Python-сервис создает face embeddings для каждого ракурса
7. Face embeddings сохраняются в память сессии
8. Игроку присваивается уникальный playerId
9. Игрок получает подтверждение успешной регистрации

### 4.2 Выбор режима игры

1. Игрок выбирает режим игры (PvP, командный, "дойти до точки")
2. В случае командного режима игрок выбирает команду
3. Игрок подтверждает выбор
4. Сервер обрабатывает запрос и создает или обновляет игровую сессию
5. Игрок получает подтверждение и переходит к игровому экрану

### 4.3 Игровой процесс

1. Игрок видит через камеру устройства реальный мир с наложенными AR-элементами
2. Игрок наводит камеру на другого игрока
3. Система распознает игрока через камеру
4. Игрок нажимает кнопку "огонь"
5. Приложение отправляет информацию о выстреле на сервер (shooterId, изображение с камеры)
6. Go-сервер передает изображение в Python-сервис
7. Python-сервис распознает цель и возвращает идентификатор цели
8. Go-сервер определяет, где произошло попадание (голова, тело, ноги)
9. Go-сервер обновляет здоровье цели и игровое состояние
10. Результаты выстрела отправляются обратно игроку
11. Приложение визуализирует результаты выстрела

### 4.4 Завершение игры

1. Система определяет условие окончания игры (все игроки кроме одного исключены, команда победила, время вышло)
2. Система объявляет победителя
3. Система отображает статистику игровой сессии
4. Игроки могут просмотреть результаты
5. Система предлагает начать новую игру или выйти
6. Система удаляет все временные данные профилей и сессии

## 5. API

### 5.1 Общие принципы

- Все API-запросы используют формат JSON для обмена данными
- Все эндпоинты возвращают стандартизированные коды ответов HTTP
- Аутентификация осуществляется через передачу playerId в заголовках или теле запроса
- Все изображения передаются в формате base64

### 5.2 Эндпоинты и методы

#### Go-сервер:

1. **POST /api/create-player-profile**
   - Создание временного цифрового профиля игрока
   - Принимает изображения с 4 ракурсов
   - Возвращает playerId

2. **POST /api/game/start**
   - Запуск новой игровой сессии
   - Принимает параметры игры (режим, количество игроков и т.д.)
   - Возвращает gameId и статус сессии

3. **POST /api/game/shot**
   - Обработка выстрела игрока
   - Принимает shooterId и изображение с камеры
   - Возвращает результат выстрела

4. **GET /api/game/status**
   - Получение текущего статуса игры
   - Принимает gameId
   - Возвращает состояние игры и игроков

#### Python-сервис:

1. **POST /recognize**
   - Распознавание лица на изображении
   - Принимает изображение в формате base64
   - Возвращает playerId и степень совпадения

### 5.3 Примеры запросов и ответов

#### Создание профиля игрока:

**Запрос:**
```json
POST /api/create-player-profile
{
  "playerId": "abc123",
  "images": ["base64_front", "base64_left", "base64_right", "base64_back"],
  "angles": ["front", "left", "right", "back"]
}
```

**Ответ:**
```json
{
  "success": true,
  "playerId": "abc123-def456",
  "message": "Player profile created successfully"
}
```

#### Запуск игры:

**Запрос:**
```json
POST /api/game/start
{
  "gameMode": "team",
  "maxPlayers": 10,
  "gameDuration": 15,
  "playerIds": ["abc123", "def456"]
}
```

**Ответ:**
```json
{
  "success": true,
  "gameId": "game-789xyz",
  "sessionStatus": "started",
  "activePlayers": 4
}
```

#### Обработка выстрела:

**Запрос:**
```json
POST /api/game/shot
{
  "shooterId": "abc123",
  "image": "base64_camera_shot",
  "timestamp": 1687891234567
}
```

**Ответ:**
```json
{
  "success": true,
  "targetId": "def456",
  "hitLocation": "body",
  "damage": 50,
  "targetHealth": 50,
  "isEliminated": false
}
```

#### Распознавание лица:

**Запрос:**
```json
POST /recognize
{
  "image": "base64_encoded_image",
  "sessionId": "game-789xyz"
}
```

**Ответ:**
```json
{
  "playerId": "abc123-def456",
  "matchScore": 0.92,
  "confidence": "high",
  "processingTime": "45ms"
}
```

## 6. Структуры данных

### 6.1 Профиль игрока

```json
{
  "playerId": "abc123-def456-789xyz",
  "faceEncodings": {
    "front": "[128 float values]",
    "left": "[128 float values]",
    "right": "[128 float values]",
    "back": "[128 float values]"
  },
  "gameStats": {
    "health": 100,
    "hits": 0,
    "eliminations": 0,
    "isActive": true,
    "teamId": "team1"
  },
  "sessionInfo": {
    "createdAt": 1687891234567,
    "lastActive": 1687891234567,
    "gameId": "game-789xyz",
    "ttl": 3600
  }
}
```

### 6.2 Игровая сессия

```json
{
  "gameId": "game-789xyz-abc123",
  "gameMode": "team",
  "players": ["abc123", "def456", "ghi789"],
  "gameState": {
    "status": "active",
    "startTime": 1687891234567,
    "duration": 15,
    "winner": null
  },
  "teams": {
    "team1": ["abc123", "ghi789"],
    "team2": ["def456"]
  }
}
```

## 7. Нефункциональные требования

### 7.1 Безопасность

- Все данные профилей должны храниться только в оперативной памяти и только на время игровой сессии
- Система не должна сохранять лица или биометрические данные между играми
- Передача данных между компонентами должна осуществляться по защищенным каналам
- В будущих версиях следует реализовать анонимизацию или шифрование профилей

### 7.2 Производительность

- Время ответа API-сервера не должно превышать 200 мс
- Время распознавания лица не должно превышать 300 мс
- Система должна поддерживать не менее 50 одновременных подключений
- Система должна обрабатывать не менее 20 запросов в секунду

### 7.3 Масштабируемость

- Архитектура должна позволять горизонтальное масштабирование компонентов
- Система должна поддерживать несколько одновременных игровых сессий
- Docker-контейнеры должны обеспечивать легкую масштабируемость

## 8. Этапы реализации

### 8.1 План разработки

| Этап | Задача | Длительность (дни) |
|------|--------|-------------------|
| 1 | Python-сервис с распознаванием по фото | 7 |
| 2 | Эндпоинт create-player-profile (Go) | 5 |
| 3 | Временное хранилище профилей | 3 |
| 4 | Android: фото с 4 ракурсов + отправка | 7 |
| 5 | Механика выстрела (определение цели) | 10 |
| 6 | Расчёт попаданий и исключений из игры | 5 |
| 7 | Выбор и запуск режима игры | 5 |
| 8 | Docker Compose и тестирование всей системы | 5 |

### 8.2 Критерии приемки

1. **Регистрация пользователя:**
   - Пользователь может создать временный профиль, сделав 4 фотографии
   - Система успешно создает face embeddings и возвращает playerId

2. **Распознавание лиц:**
   - Система распознает игроков с точностью не менее 85%
   - Время распознавания не превышает 300 мс

3. **Игровой процесс:**
   - Игрок может совершать выстрелы и получать результаты
   - Система корректно обрабатывает попадания и урон
   - Система корректно определяет победителей

4. **Безопасность:**
   - Все данные хранятся только на время сессии
   - После окончания игры все данные удаляются

## 9. Дополнительные материалы

### 9.1 Диаграммы

Приложены следующие диаграммы:
- Архитектура системы
- Диаграмма последовательности регистрации и выстрела
- BPMN диаграмма игрового процесса
- Блок-схема процесса распознавания лица

### 9.2 Макеты интерфейса

Приложены следующие макеты:
- Интерфейс AR-шутера
- Процесс регистрации с фотографированием

### 9.3 Расширения в будущем

Возможные расширения системы в будущих версиях:
- Местоположение по GPS + маршруты
- Настройки оружия (сила, дальность)
- Обмен ролями: снайпер, командир, разведка
- Web-интерфейс судьи/наблюдателя